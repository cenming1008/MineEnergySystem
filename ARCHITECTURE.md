# ç…¤çŸ¿èƒ½æºç®¡ç†ç³»ç»Ÿ - åç«¯æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„æ¦‚è§ˆ](#æ•´ä½“æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
3. [æ•°æ®æµä¸è¿è¡Œé€»è¾‘](#æ•°æ®æµä¸è¿è¡Œé€»è¾‘)
4. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
5. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (Vue 3 + Vite)                      â”‚
â”‚                    http://localhost:5173                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTP/WebSocket
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åç«¯åº”ç”¨                           â”‚
â”‚                  http://localhost:8088                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  app/main.py (åº”ç”¨å…¥å£)                               â”‚   â”‚
â”‚  â”‚  - è·¯ç”±æ³¨å†Œ                                           â”‚   â”‚
â”‚  â”‚  - ç”Ÿå‘½å‘¨æœŸç®¡ç†                                       â”‚   â”‚
â”‚  â”‚  - WebSocket ç«¯ç‚¹                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  API å±‚      â”‚  â”‚  Service å±‚   â”‚  â”‚  Core å±‚     â”‚      â”‚
â”‚  â”‚  (endpoints) â”‚  â”‚  (services)   â”‚  â”‚  (core)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Models å±‚   â”‚  â”‚  Database    â”‚  â”‚  Security    â”‚      â”‚
â”‚  â”‚  (tables)    â”‚  â”‚  (ORM)       â”‚  â”‚  (JWT/Auth)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ TimescaleDB  â”‚ â”‚   MQTT      â”‚ â”‚   Redis     â”‚
    â”‚  (PostgreSQL)â”‚ â”‚  (Mosquitto)â”‚ â”‚  (ç¼“å­˜)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. **åº”ç”¨å…¥å£å±‚** (`app/main.py`)

**èŒè´£ï¼š**
- FastAPI åº”ç”¨åˆå§‹åŒ–
- è·¯ç”±æ³¨å†Œå’Œä¸­é—´ä»¶é…ç½®
- ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯åŠ¨/å…³é—­ï¼‰
- WebSocket ç«¯ç‚¹å®šä¹‰

**å…³é”®ä»£ç ç»“æ„ï¼š**
```python
# ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨
@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨é˜¶æ®µ
    init_db()                    # åˆå§‹åŒ–æ•°æ®åº“
    RedisClient.get_client()     # è¿æ¥ Redis
    start_mqtt_background()     # å¯åŠ¨ MQTT ç›‘å¬
    
    yield  # åº”ç”¨è¿è¡Œ
    
    # å…³é—­é˜¶æ®µï¼ˆæ¸…ç†èµ„æºï¼‰

# è·¯ç”±æ³¨å†Œ
app.include_router(auth.router, prefix="/auth")
app.include_router(devices.router, prefix="/devices", dependencies=[Depends(get_current_user)])
# ... å…¶ä»–è·¯ç”±
```

**è¿è¡Œæµç¨‹ï¼š**
1. `run.py` å¯åŠ¨ â†’ è°ƒç”¨ `uvicorn.run("app.main:app")`
2. FastAPI åŠ è½½ `app` å¯¹è±¡
3. æ‰§è¡Œ `lifespan` å¯åŠ¨é˜¶æ®µ
4. æ³¨å†Œæ‰€æœ‰è·¯ç”±
5. å¯åŠ¨ HTTP/WebSocket æœåŠ¡å™¨

---

### 2. **Core æ ¸å¿ƒå±‚** (`app/core/`)

#### 2.1 **database.py** - æ•°æ®åº“è¿æ¥ç®¡ç†

**èŒè´£ï¼š**
- åˆ›å»ºæ•°æ®åº“å¼•æ“ï¼ˆSQLModelï¼‰
- åˆå§‹åŒ–è¡¨ç»“æ„
- é…ç½® TimescaleDB Hypertableï¼ˆæ—¶åºæ•°æ®ä¼˜åŒ–ï¼‰
- æä¾›æ•°æ®åº“ä¼šè¯ï¼ˆSessionï¼‰

**å…³é”®åŠŸèƒ½ï¼š**
```python
# æ•°æ®åº“è¿æ¥
engine = create_engine(DATABASE_URL, echo=True)

# åˆå§‹åŒ–æ•°æ®åº“
def init_db():
    SQLModel.metadata.create_all(engine)  # åˆ›å»ºè¡¨
    # è½¬æ¢ä¸º TimescaleDB Hypertableï¼ˆæ—¶åºä¼˜åŒ–ï¼‰
    create_hypertable('devicedata', 'timestamp')

# ä¾èµ–æ³¨å…¥ï¼šè·å–æ•°æ®åº“ä¼šè¯
def get_session():
    with Session(engine) as session:
        yield session
```

**TimescaleDB ä¼˜åŒ–ï¼š**
- `devicedata` è¡¨æŒ‰ `timestamp` åˆ†åŒº
- é€‚åˆé«˜é¢‘å†™å…¥çš„æ—¶åºæ•°æ®
- è‡ªåŠ¨æ•°æ®å‹ç¼©å’Œä¿ç•™ç­–ç•¥

---

#### 2.2 **security.py** - å®‰å…¨è®¤è¯

**èŒè´£ï¼š**
- å¯†ç å“ˆå¸Œï¼ˆbcryptï¼‰
- JWT Token ç”Ÿæˆå’ŒéªŒè¯
- å¯†ç éªŒè¯é€»è¾‘

**å…³é”®åŠŸèƒ½ï¼š**
```python
# å¯†ç å“ˆå¸Œ
def get_password_hash(password) -> str:
    # æˆªæ–­åˆ° 72 å­—èŠ‚ï¼ˆbcrypt é™åˆ¶ï¼‰
    # ä½¿ç”¨ bcrypt å“ˆå¸Œ
    
# å¯†ç éªŒè¯
def verify_password(plain_password, hashed_password) -> bool:
    # éªŒè¯ bcrypt å“ˆå¸Œ
    
# JWT Token ç”Ÿæˆ
def create_access_token(data: dict) -> str:
    # ä½¿ç”¨ HS256 ç®—æ³•
    # é»˜è®¤ 5 å°æ—¶æœ‰æ•ˆæœŸ
```

**è®¤è¯æµç¨‹ï¼š**
1. ç”¨æˆ·ç™»å½• â†’ `POST /auth/login`
2. éªŒè¯ç”¨æˆ·åå¯†ç 
3. ç”Ÿæˆ JWT Token
4. è¿”å› Token ç»™å‰ç«¯
5. åç»­è¯·æ±‚æºå¸¦ `Authorization: Bearer <token>`

---

#### 2.3 **socket_manager.py** - WebSocket è¿æ¥ç®¡ç†

**èŒè´£ï¼š**
- ç®¡ç†æ‰€æœ‰ WebSocket è¿æ¥
- å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
- è¿æ¥/æ–­å¼€å¤„ç†

**å…³é”®åŠŸèƒ½ï¼š**
```python
class ConnectionManager:
    active_connections: List[WebSocket] = []
    
    async def connect(websocket):
        # æ¥å—è¿æ¥å¹¶åŠ å…¥åˆ—è¡¨
        
    async def broadcast(message: dict):
        # å‘æ‰€æœ‰è¿æ¥å‘é€æ¶ˆæ¯
        
    def disconnect(websocket):
        # ç§»é™¤è¿æ¥
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- MQTT æ”¶åˆ°æ•°æ® â†’ é€šè¿‡ WebSocket å®æ—¶æ¨é€ç»™å‰ç«¯
- å‰ç«¯å»ºç«‹è¿æ¥ï¼š`ws://localhost:8088/ws`

---

#### 2.4 **config.py** - é…ç½®ç®¡ç†

**èŒè´£ï¼š**
- åŠ è½½æŠ¥è­¦é˜ˆå€¼é…ç½®
- ä» `config/settings.json` è¯»å–é…ç½®

**é…ç½®ç»“æ„ï¼š**
```json
{
  "default": {
    "current_max": 45.0,
    "voltage_max": 250.0,
    "voltage_min": 190.0
  },
  "device_thresholds": {
    "1": { "current_max": 50.0 }
  }
}
```

---

#### 2.5 **redis.py** - Redis å®¢æˆ·ç«¯

**èŒè´£ï¼š**
- Redis è¿æ¥ç®¡ç†ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
- å¼‚æ­¥ Redis æ“ä½œ

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç¼“å­˜çƒ­ç‚¹æ•°æ®
- ä¼šè¯å­˜å‚¨
- å®æ—¶æ•°æ®ç¼“å­˜

---

#### 2.6 **logger.py** - æ—¥å¿—ç®¡ç†

**èŒè´£ï¼š**
- ç»Ÿä¸€æ—¥å¿—é…ç½®
- æ—¥å¿—è¾“å‡ºæ ¼å¼åŒ–

---

### 3. **API å±‚** (`app/api/endpoints/`)

**èŒè´£ï¼š**
- å®šä¹‰ RESTful API ç«¯ç‚¹
- è¯·æ±‚å‚æ•°éªŒè¯
- è°ƒç”¨ Service å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
- è¿”å›å“åº”æ•°æ®

**æ¨¡å—åˆ—è¡¨ï¼š**

#### 3.1 **auth.py** - è®¤è¯æ¨¡å—
```python
POST /auth/login
- è¾“å…¥ï¼šusername, password
- è¾“å‡ºï¼šaccess_token, token_type
```

#### 3.2 **devices.py** - è®¾å¤‡ç®¡ç†
```python
GET    /devices/        # è·å–è®¾å¤‡åˆ—è¡¨
POST   /devices/        # åˆ›å»ºè®¾å¤‡
PUT    /devices/{id}    # æ›´æ–°è®¾å¤‡
DELETE /devices/{id}    # åˆ é™¤è®¾å¤‡
PATCH  /devices/{id}/toggle  # åˆ‡æ¢è®¾å¤‡çŠ¶æ€
```

#### 3.3 **telemetry.py** - é¥æµ‹æ•°æ®
```python
POST /telemetry/              # ä¸Šä¼ æ•°æ®ï¼ˆHTTPï¼‰
GET  /telemetry/{device_id}   # è·å–å†å²æ•°æ®
```

#### 3.4 **alarms.py** - æŠ¥è­¦ç®¡ç†
```python
GET    /alarms/           # è·å–æŠ¥è­¦åˆ—è¡¨
PATCH  /alarms/{id}       # å¤„ç†æŠ¥è­¦
DELETE /alarms/resolve_all # æ¸…é™¤æ‰€æœ‰æŠ¥è­¦
```

#### 3.5 **analysis.py** - æ•°æ®åˆ†æ
```python
GET /analysis/{device_id}  # è·å–è®¾å¤‡åˆ†ææ•°æ®
```

#### 3.6 **fdd.py** - æ•…éšœè¯Šæ–­
```python
GET /fdd/stats  # è·å–æ•…éšœè¯Šæ–­ç»Ÿè®¡
```

#### 3.7 **reports.py** - æŠ¥è¡¨å¯¼å‡º
```python
GET /reports/export_csv  # å¯¼å‡º CSV æŠ¥è¡¨
```

**ä¾èµ–æ³¨å…¥ï¼š**
```python
# deps.py - æƒé™éªŒè¯ä¾èµ–
def get_current_user(
    token: str = Depends(oauth2_scheme),
    session: Session = Depends(get_session)
) -> User:
    # éªŒè¯ JWT Token
    # è¿”å›å½“å‰ç”¨æˆ·å¯¹è±¡
```

---

### 4. **Service æœåŠ¡å±‚** (`app/services/`)

#### 4.1 **mqtt_worker.py** - MQTT æ¶ˆæ¯å¤„ç†

**èŒè´£ï¼š**
- è¿æ¥ MQTT Broker
- è®¢é˜…ä¸»é¢˜ `mine/telemetry`
- æ¥æ”¶è®¾å¤‡æ•°æ®
- è°ƒç”¨æ•°æ®å¤„ç†æœåŠ¡
- è§¦å‘ WebSocket å¹¿æ’­

**å…³é”®æµç¨‹ï¼š**
```python
def start_mqtt_background(on_message_callback):
    # 1. è¿æ¥ MQTT Broker
    client.connect(MQTT_BROKER, 1883, 60)
    
    # 2. è®¢é˜…ä¸»é¢˜
    client.subscribe("mine/telemetry")
    
    # 3. æ¶ˆæ¯å›è°ƒ
    def on_message_internal(client, userdata, msg):
        payload = msg.payload.decode()
        process_data(payload, broadcast_callback=on_message_callback)
    
    # 4. å¯åŠ¨åå°çº¿ç¨‹ï¼ˆéé˜»å¡ï¼‰
    client.loop_start()
```

**æ•°æ®æµï¼š**
```
MQTT Broker â†’ mqtt_worker â†’ process_data â†’ data_processor â†’ Database
                                              â†“
                                         WebSocket Broadcast â†’ Frontend
```

---

#### 4.2 **data_processor.py** - æ•°æ®å¤„ç†æœåŠ¡

**èŒè´£ï¼š**
- ä¿å­˜è®¾å¤‡æ•°æ®åˆ°æ•°æ®åº“
- åŠ è½½æŠ¥è­¦é˜ˆå€¼é…ç½®
- åˆ¤æ–­æ˜¯å¦è§¦å‘æŠ¥è­¦
- ç”ŸæˆæŠ¥è­¦è®°å½•

**å…³é”®é€»è¾‘ï¼š**
```python
def process_device_data(session, device_id, voltage, current, power, energy, timestamp):
    # 1. ä¿å­˜æ•°æ®è®°å½•
    new_record = DeviceData(...)
    session.add(new_record)
    
    # 2. åŠ è½½é˜ˆå€¼é…ç½®
    settings = load_thresholds()
    
    # 3. æŠ¥è­¦åˆ¤æ–­
    if current > limit_current:
        # ç”Ÿæˆè¿‡è½½æŠ¥è­¦
        session.add(Alarm(...))
    
    if voltage > limit_v_max or voltage < limit_v_min:
        # ç”Ÿæˆç”µå‹å¼‚å¸¸æŠ¥è­¦
        session.add(Alarm(...))
    
    # 4. æäº¤äº‹åŠ¡
    session.commit()
    return new_record
```

---

#### 4.3 **mqtt_publisher.py** - MQTT å‘å¸ƒï¼ˆå¯é€‰ï¼‰

**èŒè´£ï¼š**
- å‘ MQTT å‘å¸ƒæ§åˆ¶æŒ‡ä»¤
- ç”¨äºè¿œç¨‹æ§åˆ¶è®¾å¤‡

---

### 5. **Models æ•°æ®æ¨¡å‹å±‚** (`app/models/tables.py`)

**èŒè´£ï¼š**
- å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLModelï¼‰
- æ•°æ®éªŒè¯
- ORM æ˜ å°„

**æ•°æ®æ¨¡å‹ï¼š**

#### 5.1 **Device** - è®¾å¤‡è¡¨
```python
- id: ä¸»é”®
- name: è®¾å¤‡åç§°
- sn: åºåˆ—å·ï¼ˆå”¯ä¸€ï¼‰
- device_type: è®¾å¤‡ç±»å‹
- location: å®‰è£…ä½ç½®
- is_active: è¿è¡ŒçŠ¶æ€
- created_at, updated_at: æ—¶é—´æˆ³
```

#### 5.2 **DeviceData** - é¥æµ‹æ•°æ®è¡¨ï¼ˆæ—¶åºæ•°æ®ï¼‰
```python
- device_id: è®¾å¤‡IDï¼ˆè”åˆä¸»é”®ï¼‰
- timestamp: æ—¶é—´æˆ³ï¼ˆè”åˆä¸»é”®ï¼Œåˆ†åŒºåˆ—ï¼‰
- voltage: ç”µå‹
- current: ç”µæµ
- power: åŠŸç‡
- energy: ç´¯è®¡èƒ½è€—

# ç‰¹ç‚¹ï¼šä½¿ç”¨è”åˆä¸»é”®ï¼Œé€‚åˆ TimescaleDB åˆ†åŒº
```

#### 5.3 **Alarm** - æŠ¥è­¦è¡¨
```python
- id: ä¸»é”®
- device_id: è®¾å¤‡ID
- message: æŠ¥è­¦æ¶ˆæ¯
- timestamp: å‘ç”Ÿæ—¶é—´
- is_resolved: æ˜¯å¦å·²å¤„ç†
```

#### 5.4 **User** - ç”¨æˆ·è¡¨
```python
- id: ä¸»é”®
- username: ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
- hashed_password: å¯†ç å“ˆå¸Œ
- is_active: æ˜¯å¦æ¿€æ´»
```

---

## ğŸ”„ æ•°æ®æµä¸è¿è¡Œé€»è¾‘

### åœºæ™¯ 1: è®¾å¤‡æ•°æ®ä¸ŠæŠ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡/æ¨¡æ‹Ÿå™¨ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. å‘é€ MQTT æ¶ˆæ¯
     â”‚    Topic: mine/telemetry
     â”‚    Payload: {device_id, voltage, current, power, energy, timestamp}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Broker â”‚
â”‚ (Mosquitto)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. æ¶ˆæ¯è·¯ç”±
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mqtt_worker.py     â”‚
â”‚  on_message()       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. è§£æ JSON
     â”‚ 4. è°ƒç”¨ process_data()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_processor.py   â”‚
â”‚ process_device_data()â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. ä¿å­˜åˆ°æ•°æ®åº“
     â”‚ 6. æ£€æŸ¥æŠ¥è­¦é˜ˆå€¼
     â”‚ 7. ç”ŸæˆæŠ¥è­¦ï¼ˆå¦‚éœ€è¦ï¼‰
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TimescaleDB  â”‚      â”‚  Alarm è¡¨    â”‚
â”‚ DeviceDataè¡¨ â”‚      â”‚  (å¦‚è§¦å‘)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 8. è¿”å›æ•°æ®è®°å½•
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mqtt_worker.py     â”‚
â”‚  broadcast_callback â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 9. æ„å»º WebSocket æ¶ˆæ¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ socket_manager.py   â”‚
â”‚  broadcast()        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 10. æ¨é€ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ (Vue 3)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 2: ç”¨æˆ·ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. POST /auth/login
     â”‚    {username, password}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.py            â”‚
â”‚  login_for_access_  â”‚
â”‚  token()            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. æŸ¥è¯¢ç”¨æˆ·
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database    â”‚
â”‚  User è¡¨     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. éªŒè¯å¯†ç 
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  security.py        â”‚
â”‚  verify_password()   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. ç”Ÿæˆ JWT Token
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  security.py        â”‚
â”‚  create_access_     â”‚
â”‚  token()            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. è¿”å› Token
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ å­˜å‚¨Tokenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 3: å‰ç«¯è·å–è®¾å¤‡åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. GET /devices/
     â”‚    Header: Authorization: Bearer <token>
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  deps.py            â”‚
â”‚  get_current_user() â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. éªŒè¯ JWT Token
     â”‚ 3. è·å–ç”¨æˆ·ä¿¡æ¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  devices.py         â”‚
â”‚  get_devices()      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. æŸ¥è¯¢æ•°æ®åº“
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database    â”‚
â”‚  Device è¡¨   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. è¿”å›è®¾å¤‡åˆ—è¡¨
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ æ˜¾ç¤ºåˆ—è¡¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 4: å®æ—¶æ•°æ®æ¨é€ï¼ˆWebSocketï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. å»ºç«‹ WebSocket è¿æ¥
     â”‚    ws://localhost:8088/ws
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  main.py            â”‚
â”‚  websocket_endpoint()â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. åŠ å…¥è¿æ¥ç®¡ç†å™¨
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  socket_manager.py  â”‚
â”‚  connect()          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ (ç­‰å¾… MQTT æ•°æ®...)
     â”‚
     â”‚ 3. MQTT æ”¶åˆ°æ•°æ®
     â”‚ 4. è°ƒç”¨ broadcast()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  socket_manager.py  â”‚
â”‚  broadcast()        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. éå†æ‰€æœ‰è¿æ¥
     â”‚ 6. å‘é€ JSON æ¶ˆæ¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ å®æ—¶æ›´æ–° â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯æ¡†æ¶
- **FastAPI**: ç°ä»£ Python Web æ¡†æ¶ï¼Œè‡ªåŠ¨ API æ–‡æ¡£
- **SQLModel**: ORMï¼ŒåŸºäº SQLAlchemy å’Œ Pydantic
- **Uvicorn**: ASGI æœåŠ¡å™¨

### æ•°æ®åº“
- **TimescaleDB**: PostgreSQL æ‰©å±•ï¼Œæ—¶åºæ•°æ®ä¼˜åŒ–
- **Redis**: ç¼“å­˜å’Œä¼šè¯å­˜å‚¨

### æ¶ˆæ¯é˜Ÿåˆ—
- **MQTT (Mosquitto)**: è½»é‡çº§æ¶ˆæ¯ä¼ è¾“åè®®
- **paho-mqtt**: Python MQTT å®¢æˆ·ç«¯

### è®¤è¯å®‰å…¨
- **JWT (python-jose)**: Token è®¤è¯
- **bcrypt (passlib)**: å¯†ç å“ˆå¸Œ

### å…¶ä»–
- **WebSocket**: å®æ—¶åŒå‘é€šä¿¡
- **python-dotenv**: ç¯å¢ƒå˜é‡ç®¡ç†
- **loguru**: æ—¥å¿—ç®¡ç†

---

## ğŸ³ éƒ¨ç½²æ¶æ„

### Docker Compose æœåŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Docker Network (app_network)     â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Backend  â”‚  â”‚   DB     â”‚  â”‚  MQTT  â”‚â”‚
â”‚  â”‚ :8088    â”‚  â”‚ :5432    â”‚  â”‚ :1883  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  Redis  â”‚                           â”‚
â”‚  â”‚ :6379   â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡è¯´æ˜

1. **backend** (FastAPI)
   - ç«¯å£: 8088
   - ä¾èµ–: db, mqtt, redis
   - ç¯å¢ƒå˜é‡: DATABASE_URL, REDIS_URL, MQTT_BROKER

2. **db** (TimescaleDB)
   - ç«¯å£: 5433 (æ˜ å°„åˆ°å®¿ä¸»æœº)
   - æ•°æ®æŒä¹…åŒ–: ./pg_data

3. **mqtt** (Mosquitto)
   - ç«¯å£: 1883, 9001
   - é…ç½®: ./mosquitto/config

4. **redis** (Redis)
   - ç«¯å£: 6379
   - æ•°æ®æŒä¹…åŒ–: redis_data volume

---

## ğŸ“ å…³é”®è®¾è®¡æ¨¡å¼

### 1. **ä¾èµ–æ³¨å…¥ (Dependency Injection)**
```python
def get_devices(session: Session = Depends(get_session)):
    # FastAPI è‡ªåŠ¨æ³¨å…¥æ•°æ®åº“ä¼šè¯
```

### 2. **å•ä¾‹æ¨¡å¼ (Singleton)**
```python
class RedisClient:
    _client = None
    @classmethod
    def get_client(cls):
        if cls._client is None:
            cls._client = redis.from_url(...)
        return cls._client
```

### 3. **å·¥å‚æ¨¡å¼ (Factory)**
```python
def get_session():
    with Session(engine) as session:
        yield session  # ç”Ÿæˆå™¨æ¨¡å¼
```

### 4. **è§‚å¯Ÿè€…æ¨¡å¼ (Observer)**
```python
# MQTT æ¶ˆæ¯ â†’ è§¦å‘ WebSocket å¹¿æ’­
mqtt_message â†’ process_data â†’ broadcast_callback â†’ WebSocket clients
```

---

## ğŸ” å…³é”®æ–‡ä»¶è¯´æ˜

### å¯åŠ¨æµç¨‹
1. `run.py` â†’ å¯åŠ¨ Uvicorn æœåŠ¡å™¨
2. `app/main.py` â†’ FastAPI åº”ç”¨åˆå§‹åŒ–
3. `lifespan()` â†’ åˆå§‹åŒ–æ•°æ®åº“ã€Redisã€MQTT
4. æ³¨å†Œè·¯ç”± â†’ å¼€å§‹æ¥æ”¶è¯·æ±‚

### æ•°æ®æµå‘
- **å†™å…¥**: MQTT â†’ mqtt_worker â†’ data_processor â†’ Database
- **è¯»å–**: Frontend â†’ API â†’ Database â†’ Frontend
- **å®æ—¶**: MQTT â†’ mqtt_worker â†’ WebSocket â†’ Frontend

### å®‰å…¨æœºåˆ¶
- JWT Token è®¤è¯
- å¯†ç  bcrypt å“ˆå¸Œ
- CORS ä¸­é—´ä»¶
- ä¾èµ–æ³¨å…¥æƒé™éªŒè¯

---

## ğŸ¯ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ª**åˆ†å±‚æ¶æ„**çš„å·¥ä¸šçº§èƒ½æºç®¡ç†ç³»ç»Ÿï¼š

1. **API å±‚**: å¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°éªŒè¯
2. **Service å±‚**: ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ•°æ®åŠ å·¥
3. **Core å±‚**: åŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ã€å®‰å…¨ã€WebSocketï¼‰
4. **Model å±‚**: æ•°æ®æ¨¡å‹å®šä¹‰

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… å®æ—¶æ•°æ®æ¨é€ï¼ˆMQTT + WebSocketï¼‰
- âœ… æ—¶åºæ•°æ®ä¼˜åŒ–ï¼ˆTimescaleDBï¼‰
- âœ… å®‰å…¨è®¤è¯ï¼ˆJWT + bcryptï¼‰
- âœ… æŠ¥è­¦ç›‘æ§ï¼ˆé˜ˆå€¼æ£€æµ‹ï¼‰
- âœ… å¾®æœåŠ¡æ¶æ„ï¼ˆDocker Composeï¼‰

**æ‰©å±•æ€§ï¼š**
- æ˜“äºæ·»åŠ æ–°çš„ API ç«¯ç‚¹
- æ˜“äºæ·»åŠ æ–°çš„æ•°æ®å¤„ç†é€»è¾‘
- æ˜“äºé›†æˆæ–°çš„æ•°æ®æº

